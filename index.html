<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NYC Apartment Finder</title>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  
  <!-- Firebase App (the core Firebase SDK) -->
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
  <!-- Firebase Firestore (compat version) -->
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
  
  <style>
    /* Global Styles */
    body {
      margin: 0;
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(135deg, #f0f4f8, #d9e2ec);
      color: #333;
      line-height: 1.6;
    }
    a {
      color: #667eea;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    
    /* Header Styles */
    header {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
      padding: 40px 20px;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    header h1 {
      margin: 0;
      font-size: 2.8em;
      letter-spacing: 1px;
    }
    header p {
      margin: 8px 0 0;
      font-size: 1.2em;
    }
    
    /* Container */
    .container {
      max-width: 1300px;
      margin: 40px auto;
      background: #fff;
      padding: 20px 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    /* Controls */
    #sortControls,
    #filterControls {
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      align-items: center;
    }
    #sortControls select, 
    #filterControls select,
    #filterControls input[type="number"] {
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1em;
    }
    #filterControls label {
      margin-right: 10px;
    }
    #filterAmenities label {
      display: inline-block;
      margin-right: 10px;
      font-weight: 400;
      white-space: nowrap;
    }
    .max-filter-container {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    .max-filter-item {
      display: flex;
      flex-direction: column;
    }
    .max-filter-item label {
      margin-bottom: 4px;
      font-weight: 400;
    }

    /* Favorite Indicator */
    .favorite-indicator {
      color: gold;
      margin-right: 4px;
      font-size: 1.2em;
      vertical-align: middle;
    }
    
    /* Responsive Table Container */
    .table-responsive {
      width: 100%;
      overflow-x: auto; /* Horizontal scrolling if needed */
      margin-top: 20px;
    }
    
    /* Table Styling */
    table {
      width: 100%;
      min-width: 900px;
      border-collapse: collapse;
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    th, td {
      text-align: left;
      padding: 14px;
      border-bottom: 1px solid #e0e0e0;
      vertical-align: middle;
    }
    th {
      background: #f7f7f7;
      font-weight: 500;
    }
    tr:nth-child(even) td {
      background: #fbfbfb;
    }
    tr:hover td {
      background: #f1f5f8;
    }
    
    /* Keep the Original URL column narrower */
    table th:nth-child(9),
    table td:nth-child(9) {
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    /* Inputs and Buttons */
    input[type="text"],
    input[type="url"],
    input[type="number"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 1em;
    }
    button {
      padding: 8px 16px;
      background: #667eea;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s ease;
      font-size: 1em;
    }
    button:hover {
      background: #556cd6;
    }
    
    .amenity-option {
      display: inline-block;
      margin-right: 10px;
      white-space: nowrap;
    }
    
    /* Footer */
    .footer {
      text-align: center;
      padding: 10px;
      margin-top: 40px;
      font-size: 0.9em;
      color: #666;
    }
    
    /* Responsive Adjustments */
    @media (max-width: 768px) {
      header h1 {
        font-size: 2.2em;
      }
      .container {
        margin: 20px;
        padding: 20px;
      }
      #sortControls, #filterControls {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
  
  <script>
    // Firebase configuration – replace with your own configuration if needed.
    const firebaseConfig = {
      apiKey: "AIzaSyAcRL-9n99aA0HPjPQKA8OlTHMzWQD1vBQ",
      authDomain: "nyc-apt-tracker.firebaseapp.com",
      projectId: "nyc-apt-tracker",
      storageBucket: "nyc-apt-tracker.firebasestorage.app",
      messagingSenderId: "176381773971",
      appId: "1:176381773971:web:2ad0ce9e11f6a6667ae566"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Globals
    const workAddressX = "Goldman Sachs Headquarters, 200 West St, New York, NY";
    const workAddressY = "Btg Pactual, 601 Lexington Ave #57, New York, NY";
    const amenityOptions = ["Laundry Room", "AC", "Gym", "Game room", "Elevator"];
    let listings = [];

    // Format price
    function formatPrice(price) {
      let num = parseFloat(price.replace(/[^0-9.]/g, ""));
      if (isNaN(num)) return price;
      return new Intl.NumberFormat('en-US', {style:'currency',currency:'USD',maximumFractionDigits:0}).format(num);
    }

    // Build map link
    function buildGoogleMapsLink(o, d) {
      return `https://www.google.com/maps/dir/${encodeURIComponent(o)}/${encodeURIComponent(d)}/`;
    }
    function getSelectedAmenities(container) {
      return Array.from(container.querySelectorAll('input[type="checkbox"]:checked'))
                  .map(cb => cb.value).join(', ');
    }
    function clearFilters() {
      document.getElementById('filterNeighborhood').value = "All";
      document.getElementById('filterMaxPrice').value = "";
      document.getElementById('filterMaxDistanceGS').value = "";
      document.getElementById('filterMaxDistanceBTG').value = "";
      document.getElementById('filterFavorites').checked = false;
      document.querySelectorAll('#filterAmenities input').forEach(cb => cb.checked = false);
    }

    // Firestore CRUD
    async function loadListings() {
      try {
        const snap = await db.collection("listings").get();
        listings = snap.docs.map(d => {
          const data = d.data();
          return {
            id:       d.id,
            price:    data.price || '',
            location: data.location || '',
            neighborhood: data.neighborhood || '',
            bathrooms:    data.bathrooms || 0,
            bedrooms:     data.bedrooms || 0,
            distanceToWorkX: data.distanceToWorkX || '',
            distanceToWorkY: data.distanceToWorkY || '',
            amenities:      data.amenities || '',
            originalUrl:    data.originalUrl || '',
            notes:          data.notes || '',
            favorite:       data.favorite || false
          };
        });
        refreshTable();
      } catch(e) {
        console.error(e);
      }
    }

    async function addNewListingHandler() {
      const loc = document.getElementById('newLocation').value.trim();
      if (!loc) return alert("Please enter the apartment location.");
      const doc = {
        price:    document.getElementById('newPrice').value.trim() || 'N/A',
        location: loc,
        neighborhood: document.getElementById('newNeighborhood').value.trim() || 'N/A',
        bathrooms:    +document.getElementById('newBathrooms').value || 0,
        bedrooms:     +document.getElementById('newBedrooms').value || 0,
        distanceToWorkX: buildGoogleMapsLink(loc, workAddressX),
        distanceToWorkY: buildGoogleMapsLink(loc, workAddressY),
        amenities:      getSelectedAmenities(document.getElementById("newAmenitiesCell")) || 'N/A',
        originalUrl:    document.getElementById('newOriginalUrl').value.trim() || 'N/A',
        notes:          document.getElementById('newNotes').value.trim() || '',
        favorite:       false
      };
      await db.collection("listings").add(doc);
      clearFilters();
      loadListings();
      ['newPrice','newLocation','newNeighborhood','newBathrooms','newBedrooms','newOriginalUrl','newNotes']
        .forEach(id => document.getElementById(id).value = '');
      document.querySelectorAll("#newAmenitiesCell input").forEach(cb=>cb.checked=false);
    }

    async function updateListingById(id, upd) {
      await db.collection("listings").doc(id).update(upd);
      loadListings();
    }
    async function deleteListingById(id) {
      await db.collection("listings").doc(id).delete();
      loadListings();
    }

    // Create <td><input>…</td>
    function createInputCell(val, type='text') {
      const td = document.createElement('td');
      const inp = document.createElement('input');
      inp.type = type; inp.value = val;
      td.appendChild(inp);
      return td;
    }

    // Enter edit mode
    function enableEditing(row, id) {
      const it = listings.find(x=>x.id===id);
      if(!it) return;
      row.innerHTML='';
      // text inputs
      const pc = createInputCell(it.price);
      const lc = createInputCell(it.location);
      const nc = createInputCell(it.neighborhood);
      const bc = createInputCell(it.bathrooms,'number');
      const bedc = createInputCell(it.bedrooms,'number');
      const gsc = createInputCell(it.distanceToWorkX);
      const btc = createInputCell(it.distanceToWorkY);
      row.append(pc,lc,nc,bc,bedc,gsc,btc);
      // amenities
      const atd = document.createElement('td');
      amenityOptions.forEach(o=>{
        const lab = document.createElement('label');
        lab.className='amenity-option';
        const cb = document.createElement('input');
        cb.type='checkbox'; cb.value=o;
        if(it.amenities.split(',').map(a=>a.trim()).includes(o)) cb.checked=true;
        lab.append(cb,document.createTextNode(o));
        atd.appendChild(lab);
      });
      row.appendChild(atd);
      // url & notes
      const utd = createInputCell(it.originalUrl,'url');
      const nd  = createInputCell(it.notes);
      row.append(utd, nd);
      // actions
      const actionTd = document.createElement('td');
      // Save
      const save = document.createElement('button');
      save.textContent='Save';
      save.addEventListener('click',()=>{
        const upd = {
          price:    pc.querySelector('input').value || 'N/A',
          location: lc.querySelector('input').value || 'N/A',
          neighborhood: nc.querySelector('input').value || 'N/A',
          bathrooms:    parseInt(bc.querySelector('input').value,10)||0,
          bedrooms:     parseInt(bedc.querySelector('input').value,10)||0,
          distanceToWorkX: gsc.querySelector('input').value||'N/A',
          distanceToWorkY: btc.querySelector('input').value||'N/A',
          amenities: Array.from(atd.querySelectorAll('input:checked')).map(cb=>cb.value).join(', ')||'N/A',
          originalUrl:    utd.querySelector('input').value||'N/A',
          notes:          nd.querySelector('input').value||'',
          favorite:       it.favorite
        };
        updateListingById(id, upd);
      });
      actionTd.appendChild(save);
      // Cancel
      const cancel = document.createElement('button');
      cancel.textContent='Cancel';
      cancel.addEventListener('click',refreshTable);
      actionTd.appendChild(cancel);
      // Delete
      const del = document.createElement('button');
      del.textContent='Delete';
      del.addEventListener('click',()=>{ if(confirm("Delete?")) deleteListingById(id); });
      actionTd.appendChild(del);
      row.appendChild(actionTd);
    }

    // Filter + display
    function getFilteredListings() {
      let arr = listings.slice();
      // favorite filter
      if(document.getElementById('filterFavorites').checked) {
        arr = arr.filter(x=>x.favorite);
      }
      // neighborhood
      const nf = document.getElementById('filterNeighborhood').value.toLowerCase();
      if(nf!=='all') arr = arr.filter(x=>x.neighborhood.toLowerCase()===nf);
      // amenities
      const reqA = Array.from(document.querySelectorAll('#filterAmenities input:checked')).map(cb=>cb.value.toLowerCase());
      if(reqA.length){
        arr = arr.filter(x=>{
          const have = x.amenities.toLowerCase().split(',').map(a=>a.trim());
          return reqA.every(a=>have.includes(a));
        });
      }
      // max price
      const mp = parseFloat(document.getElementById('filterMaxPrice').value);
      if(!isNaN(mp)){
        arr = arr.filter(x=>{
          const p = parseFloat(x.price.replace(/[^0-9.]/g,''))||0;
          return p<=mp;
        });
      }
      // max GS dist
      const mg = parseFloat(document.getElementById('filterMaxDistanceGS').value);
      if(!isNaN(mg)){
        arr = arr.filter(x=>{
          if(x.distanceToWorkX.startsWith('http')) return true;
          const d = parseFloat(x.distanceToWorkX.replace(/[^0-9.]/g,''))||0;
          return d<=mg;
        });
      }
      // max BTG dist
      const mb = parseFloat(document.getElementById('filterMaxDistanceBTG').value);
      if(!isNaN(mb)){
        arr = arr.filter(x=>{
          if(x.distanceToWorkY.startsWith('http')) return true;
          const d = parseFloat(x.distanceToWorkY.replace(/[^0-9.]/g,''))||0;
          return d<=mb;
        });
      }
      return arr.map(item=>({ item }));
    }

    function createDistanceCell(value) {
      const td = document.createElement('td');
      if (value.startsWith('http')) {
        const a = document.createElement('a');
        a.href = value; a.textContent = 'View Route'; a.target = '_blank';
        td.appendChild(a);
      } else {
        td.textContent = value;
      }
      return td;
    }

    function createTextCell(content) {
      const td = document.createElement('td');
      td.innerHTML = content;
      return td;
    }

    function createRow(listing) {
      const tr = document.createElement('tr');
      tr.setAttribute('data-id', listing.id);

      // favorite star
      const actionTd = document.createElement('td');
      const star = document.createElement('span');
      star.className = 'favorite-indicator';
      star.textContent = listing.favorite ? '★' : '☆';
      actionTd.appendChild(star);
      // favorite toggle
      const favBtn = document.createElement('button');
      favBtn.textContent = listing.favorite ? 'Unfavorite' : 'Favorite';
      favBtn.addEventListener('click',()=>
        updateListingById(listing.id, { favorite: !listing.favorite })
      );
      actionTd.appendChild(favBtn);

      // the rest of cells
      tr.appendChild(createTextCell(formatPrice(listing.price)));
      tr.appendChild(createTextCell(listing.location));
      tr.appendChild(createTextCell(listing.neighborhood));
      tr.appendChild(createTextCell(listing.bathrooms));
      tr.appendChild(createTextCell(listing.bedrooms));
      tr.appendChild(createDistanceCell(listing.distanceToWorkX));
      tr.appendChild(createDistanceCell(listing.distanceToWorkY));
      tr.appendChild(createTextCell(listing.amenities));
      // original url
      const urlTd = document.createElement('td');
      const a = document.createElement('a');
      a.href = listing.originalUrl; a.textContent = 'link'; a.target = '_blank';
      urlTd.appendChild(a);
      tr.appendChild(urlTd);
      tr.appendChild(createTextCell(listing.notes));

      // edit & delete
      const editBtn = document.createElement('button');
      editBtn.textContent = 'Edit';
      editBtn.addEventListener('click',()=> enableEditing(tr, listing.id));
      actionTd.appendChild(editBtn);
      const delBtn = document.createElement('button');
      delBtn.textContent = 'Delete';
      delBtn.addEventListener('click',()=>{ if(confirm("Delete?")) deleteListingById(listing.id); });
      actionTd.appendChild(delBtn);

      tr.appendChild(actionTd);
      return tr;
    }

    function refreshTable() {
      // repopulate neighborhoods
      const sel = document.getElementById('filterNeighborhood');
      const cur = sel.value;
      const ns = Array.from(new Set(listings.map(x=>x.neighborhood).filter(n=>n)));
      sel.innerHTML = '<option value="All">All</option>';
      ns.forEach(n=>{
        const o = document.createElement('option');
        o.value = n; o.textContent = n;
        sel.appendChild(o);
      });
      if(ns.includes(cur)) sel.value = cur;

      // clear old rows
      const tbody = document.querySelector('#listingsTable tbody');
      Array.from(tbody.querySelectorAll('tr')).forEach(r=>{
        if(r.id!=='newListingRow') r.remove();
      });
      // add new
      getFilteredListings().forEach(o=>{
        tbody.appendChild(createRow(o.item));
      });
    }

    // Event listeners
    document.getElementById('sortBtn').addEventListener('click',()=>{
      const c = document.getElementById('sortCriteria').value;
      listings.sort((a,b)=>{
        const va = parseFloat(a[c].replace(/[^\d.]/g,''))||0;
        const vb = parseFloat(b[c].replace(/[^\d.]/g,''))||0;
        return va-vb;
      });
      refreshTable();
    });
    document.getElementById('filterBtn').addEventListener('click',refreshTable);
    document.getElementById('clearFiltersBtn').addEventListener('click',()=>{
      clearFilters();
      refreshTable();
    });
    document.getElementById('addListingBtn').addEventListener('click',addNewListingHandler);
    window.addEventListener('load',loadListings);
  </script>
</body>
</html>
