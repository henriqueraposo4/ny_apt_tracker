<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NYC Apartment Finder</title>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  
  <!-- Firebase App (the core Firebase SDK) -->
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
  <!-- Firebase Firestore (compat version) -->
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
  
  <style>
    /* Global Styles */
    body {
      margin: 0;
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(135deg, #f0f4f8, #d9e2ec);
      color: #333;
      line-height: 1.6;
    }
    a {
      color: #667eea;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    
    /* Header Styles */
    header {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
      padding: 40px 20px;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    header h1 {
      margin: 0;
      font-size: 2.8em;
      letter-spacing: 1px;
    }
    header p {
      margin: 8px 0 0;
      font-size: 1.2em;
    }
    
    /* Container */
    .container {
      max-width: 1300px;
      margin: 40px auto;
      background: #fff;
      padding: 20px 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    /* Controls */
    #sortControls,
    #filterControls {
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      align-items: center;
    }
    #sortControls select, 
    #filterControls select,
    #filterControls input[type="number"] {
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1em;
    }
    #filterControls label {
      margin-right: 10px;
    }
    #filterAmenities label {
      display: inline-block;
      margin-right: 10px;
      font-weight: 400;
      white-space: nowrap;
    }
    .max-filter-container {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    .max-filter-item {
      display: flex;
      flex-direction: column;
    }
    .max-filter-item label {
      margin-bottom: 4px;
      font-weight: 400;
    }

    /* Favorite Indicator */
    .favorite-indicator {
      color: gold;
      margin-right: 4px;
      font-size: 1.2em;
      vertical-align: middle;
    }
    
    /* Responsive Table Container */
    .table-responsive {
      width: 100%;
      overflow-x: auto; /* Horizontal scrolling if needed */
      margin-top: 20px;
    }
    
    /* Table Styling */
    table {
      width: 100%;
      min-width: 900px;
      border-collapse: collapse;
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    th, td {
      text-align: left;
      padding: 14px;
      border-bottom: 1px solid #e0e0e0;
      vertical-align: middle;
    }
    th {
      background: #f7f7f7;
      font-weight: 500;
    }
    tr:nth-child(even) td {
      background: #fbfbfb;
    }
    tr:hover td {
      background: #f1f5f8;
    }
    
    /* Keep the Original URL column narrower */
    table th:nth-child(9),
    table td:nth-child(9) {
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    /* Inputs and Buttons */
    input[type="text"],
    input[type="url"],
    input[type="number"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 1em;
    }
    button {
      padding: 8px 16px;
      background: #667eea;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s ease;
      font-size: 1em;
    }
    button:hover {
      background: #556cd6;
    }
    
    .amenity-option {
      display: inline-block;
      margin-right: 10px;
      white-space: nowrap;
    }
    
    /* Footer */
    .footer {
      text-align: center;
      padding: 10px;
      margin-top: 40px;
      font-size: 0.9em;
      color: #666;
    }
    
    /* Responsive Adjustments */
    @media (max-width: 768px) {
      header h1 {
        font-size: 2.2em;
      }
      .container {
        margin: 20px;
        padding: 20px;
      }
      #sortControls, #filterControls {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
  
  <script>
    // Firebase configuration – replace with your own configuration if needed.
    const firebaseConfig = {
      apiKey: "AIzaSyAcRL-9n99aA0HPjPQKA8OlTHMzWQD1vBQ",
      authDomain: "nyc-apt-tracker.firebaseapp.com",
      projectId: "nyc-apt-tracker",
      storageBucket: "nyc-apt-tracker.firebasestorage.app",
      messagingSenderId: "176381773971",
      appId: "1:176381773971:web:2ad0ce9e11f6a6667ae566"
    };

    // Initialize Firebase and Firestore using compat libraries.
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Define global variables: target addresses and amenity options.
    const workAddressX = "Goldman Sachs Headquarters, 200 West St, New York, NY";
    const workAddressY = "Btg Pactual, 601 Lexington Ave #57, New York, NY";
    const amenityOptions = ["Laundry Room", "AC", "Gym", "Game room", "Elevator"];

    // Global array to hold listings (each listing includes its Firestore document ID).
    let listings = [];

    // FORMAT THE PRICE INTO DOLLAR FORMAT, E.G. 3973 -> "$3,973"
    function formatPrice(price) {
      let number = parseFloat(price.replace(/[^0-9.]/g, ""));
      if (isNaN(number)) {
        return price;
      }
      return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(number);
    }


    // --- FIRESTORE FUNCTIONS ---
    async function loadListings() {
      try {
        const querySnapshot = await db.collection("listings").get();
        listings = [];
        querySnapshot.forEach(doc => {
          let data = doc.data();
          data.id = doc.id;
          data.favorite = data.favorite || false;
          listings.push(data);
        });
        refreshTable();
      } catch (error) {
        console.error("Error loading listings: ", error);
      }
    }
    
    async function addNewListingHandler() {
      let price = document.getElementById('newPrice').value.trim();
      let location = document.getElementById('newLocation').value.trim();
      if (!location) {
        alert("Please enter the apartment location so travel links can be generated.");
        return;
      }
      const linkGS = buildGoogleMapsLink(location, workAddressX);
      const linkBTG = buildGoogleMapsLink(location, workAddressY);
      let newListing = {
        price: price || 'N/A',
        location: location,
        neighborhood: document.getElementById('newNeighborhood').value.trim() || 'N/A',
        bathrooms: +document.getElementById('newBathrooms').value || 0,
        bedrooms: +document.getElementById('newBedrooms').value || 0,
        distanceToWorkX: linkGS,
        distanceToWorkY: linkBTG,
        amenities: getSelectedAmenities(document.getElementById("newAmenitiesCell")) || 'N/A',
        originalUrl: document.getElementById('newOriginalUrl').value.trim() || 'N/A',
        notes: document.getElementById('newNotes').value.trim() || '',
        favorite: false
      };
      try {
        await db.collection("listings").add(newListing);
        clearFilters();
        loadListings();
      } catch (error) {
        console.error("Error adding listing: ", error);
      }
      ['newPrice','newLocation','newNeighborhood','newBathrooms','newBedrooms','newOriginalUrl','newNotes']
        .forEach(id => document.getElementById(id).value = '');
      document.querySelectorAll("#newAmenitiesCell input[type='checkbox']").forEach(cb => cb.checked = false);
    }
    
    async function updateListingById(docId, updatedListing) {
      try {
        await db.collection("listings").doc(docId).update(updatedListing);
        loadListings();
      } catch (error) {
        console.error("Error updating listing: ", error);
      }
    }
    
    async function deleteListingById(docId) {
      try {
        await db.collection("listings").doc(docId).delete();
        loadListings();
      } catch (error) {
        console.error("Error deleting listing: ", error);
      }
    }
    
    // --- HELPER FUNCTIONS ---
    function buildGoogleMapsLink(origin, destination) {
      return "https://www.google.com/maps/dir/" +
             encodeURIComponent(origin) + "/" + encodeURIComponent(destination) + "/";
    }
    
    function getSortableValue(value) {
      if (value.trim().toLowerCase().startsWith("http")) {
        return Infinity;
      }
      let num = parseFloat(value.replace(/[^0-9.]/g, ""));
      return isNaN(num) ? 0 : num;
    }
    
    function createDistanceCell(value) {
      let td = document.createElement('td');
      if (value.trim().toLowerCase().startsWith("http")) {
        let a = document.createElement("a");
        a.href = value;
        a.target = "_blank";
        a.textContent = "View Route";
        td.appendChild(a);
      } else {
        td.textContent = value;
      }
      return td;
    }
    
    function createTextCell(content) {
      let td = document.createElement('td');
      td.innerHTML = content;
      return td;
    }
    
    function createInputCell(value, type = 'text') {
      let td = document.createElement('td');
      let input = document.createElement('input');
      input.type = type;
      input.value = value;
      td.appendChild(input);
      return td;
    }

    // ————————————————————————————————
    // Full edit mode, preserving favorite status
    function enableEditing(row, docId) {
      const listing = listings.find(l => l.id === docId);
      if (!listing) return console.error("Listing not found");
      row.innerHTML = '';

      // Editable cells
      const priceCell    = createInputCell(listing.price);
      const locationCell = createInputCell(listing.location);
      const neighCell    = createInputCell(listing.neighborhood);
      const bathCell     = createInputCell(listing.bathrooms, 'number');
      const bedCell      = createInputCell(listing.bedrooms,  'number');
      const gsCell       = createInputCell(listing.distanceToWorkX);
      const btgCell      = createInputCell(listing.distanceToWorkY);
      row.append(priceCell, locationCell, neighCell, bathCell, bedCell, gsCell, btgCell);

      // Amenities
      const amenitiesTd = document.createElement('td');
      amenityOptions.forEach(opt => {
        const label = document.createElement('label');
        label.className = 'amenity-option';
        const cb = document.createElement('input');
        cb.type  = 'checkbox';
        cb.value = opt;
        if (listing.amenities.split(',').map(a=>a.trim()).includes(opt)) cb.checked = true;
        label.append(cb, document.createTextNode(opt));
        amenitiesTd.appendChild(label);
      });
      row.appendChild(amenitiesTd);

      // URL & Notes
      const urlCell   = createInputCell(listing.originalUrl, 'url');
      const notesCell = createInputCell(listing.notes);
      row.append(urlCell, notesCell);

      // Actions: Save, Cancel, Delete
      const actionTd = document.createElement('td');
      // Save
      const saveBtn = document.createElement('button');
      saveBtn.textContent = 'Save';
      saveBtn.addEventListener('click', () => {
        const updated = {
          price:    priceCell.querySelector('input').value.trim() || 'N/A',
          location: locationCell.querySelector('input').value.trim() || 'N/A',
          neighborhood: neighCell   .querySelector('input').value.trim() || 'N/A',
          bathrooms:    parseInt(bathCell.querySelector('input').value, 10) || 0,
          bedrooms:     parseInt(bedCell .querySelector('input').value, 10) || 0,
          distanceToWorkX: gsCell .querySelector('input').value.trim() || 'N/A',
          distanceToWorkY: btgCell.querySelector('input').value.trim() || 'N/A',
          amenities: Array
            .from(amenitiesTd.querySelectorAll('input[type="checkbox"]:checked'))
            .map(cb => cb.value)
            .join(', ') || 'N/A',
          originalUrl: urlCell  .querySelector('input').value.trim() || 'N/A',
          notes:       notesCell.querySelector('input').value.trim() || '',
          favorite:    listing.favorite
        };
        updateListingById(docId, updated);
      });
      actionTd.appendChild(saveBtn);

      // Cancel
      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'Cancel';
      cancelBtn.addEventListener('click', refreshTable);
      actionTd.appendChild(cancelBtn);

      // Delete
      const delBtn = document.createElement('button');
      delBtn.textContent = 'Delete';
      delBtn.addEventListener('click', () => {
        if (confirm("Are you sure you want to delete this listing?")) {
          deleteListingById(docId);
        }
      });
      actionTd.appendChild(delBtn);

      row.appendChild(actionTd);
    }

    // --- DISPLAY FUNCTIONS ---
    function createRow(listing) {
      // … your existing createRow implementation …
    }
    function refreshTable() {
      // … your existing refreshTable implementation …
    }

    // --- EVENT LISTENERS ---
    document.getElementById('sortBtn').addEventListener('click', function() {
      // … unchanged …
    });
    document.getElementById('filterBtn').addEventListener('click', refreshTable);
    document.getElementById('clearFiltersBtn').addEventListener('click', function() {
      clearFilters();
      refreshTable();
    });
    document.getElementById('addListingBtn').addEventListener('click', addNewListingHandler);
    window.addEventListener('load', loadListings);
  </script>
</body>
</html>
